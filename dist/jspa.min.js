Object.inherit||require("jahcode");var jspa={error:{},connector:{},metamodel:{},message:{},util:{},binding:{},collection:{}};"undefined"!=typeof module&&(module.exports=jspa),jspa.StopIteration=Error.inherit({initialize:function(){this.superCall("No such element.")}}),jspa.Iterator=Trait.inherit({extend:{conv:function(a){return a?a.items&&Function.isInstance(a.items)?a.items():Array.isInstance(a)?new jspa.IndexIterator(a.length,function(b){return[b,a[b]]}):new jspa.PropertyIterator(a):void 0}},StopIteration:new jspa.StopIteration,hasNext:!1,iterator:function(){return this},next:function(){throw this.StopIteration}}),jspa.IndexIterator=Object.inherit(jspa.Iterator,{initialize:function(a,b){this.length=a,this.index=0,this.hasNext=this.index<this.length,b&&(this.accessor=b)},next:function(){if(!this.hasNext)throw this.StopIteration;var a=this.accessor(this.index);return this.hasNext=++this.index<this.length,a}}),jspa.PropertyIterator=jspa.IndexIterator.inherit({initialize:function(a){this.obj=a,this.names=Object.getOwnPropertyNames(a)},accessor:function(a){if(this.names.length>=a)throw this.StopIteration;var b=this.names[a];return[b,this.object[b]]}}),jspa.Iterable=Trait.inherit({forEach:function(a,b){if(!a||!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c=jspa.Iterator(this);c.hasNext;){var d=c.next();a.call(b,d[1],d[0],this)}},every:function(a,b){if(!a||!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c=jspa.Iterator(this);c.hasNext;){var d=c.next();if(!a.call(b,d[1],d[0],this))return!1}return!0},some:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c=jspa.Iterator(this);c.hasNext;){var d=c.next();if(a.call(b,d[1],d[0],this))return!0}return!1},filter:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c=new this.constructor,d=jspa.Iterator(this);d.hasNext;){var e=d.next();a.call(b,e[1],e[0],this)&&(c.set?c.set(e[0],e[1]):c.add(e[1]))}return c},map:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");for(var c=new this.constructor,d=jspa.Iterator(this);d.hasNext;){var e=d.next();e=a.call(b,e[1],e[0],this),c.set?c.set(e[0],e[1]):c.add(e[1])}return c},reduce:function(a,b){if(!Function.isInstance(a))throw new TypeError(a+" is not a function");var c=jspa.Iterator(this);for(1==arguments.length&&(b=c.next()[1]);c.hasNext;)item=c.next(),b=a.call(null,b,item[1],item[0],this);return b}}),jspa.Collection=Object.inherit(jspa.Iterable,{extend:{conv:function(a){if(a){if(Array.isInstance(a)){for(var b=new this,c=0,d=a.length;d>c;++c)b.add(a[c]);return b}if(jspa.Collection.isInstance(a))return new this(a)}return null}},size:0,seq:[],initialize:function(a){if(this.seq=[],this.size=0,a)for(var b=a.iterator();b.hasNext;)this.add(b.next())},has:function(a){return-1!=this.seq.indexOf(a)},add:function(a){this.seq[this.size++]=a},remove:function(a){var b=this.seq.indexOf(a);b>-1&&(this.seq.splice(b,1),this.size--)},items:function(){var a=this.seq;return new jspa.IndexIterator(this.size,function(b){return[b,a[b]]})},iterator:function(){var a=this.seq;return new jspa.IndexIterator(this.size,function(b){return a[b]})},toString:function(){return this.seq.toString()},toJSON:function(){return this.seq}}),jspa.List=jspa.Collection.inherit({extend:{conv:jspa.Collection.conv},get:function(a){return 0>a&&(a=this.size+a),a>=0&&a<this.size?this.seq[a]:void 0},set:function(a,b){0>a&&(a=this.size+a),0>a?(this.seq.unshift(b),this.size++):a>=this.size?(this.seq.push(b),this.size++):this.seq[a]=b},indexOf:function(a){return this.seq.indexOf(a)},lastIndexOf:function(a){return this.seq.lastIndexOf(a)}}),jspa.Set=jspa.Collection.inherit({extend:{conv:jspa.Collection.conv},add:function(a){var b=this.seq.indexOf(a);0>b&&(this.seq[this.size++]=a)}}),jspa.Map=jspa.Collection.inherit({extend:{conv:function(a){if(a)if(Array.isInstance(a)){for(var b,c=new this,d=0;(b=a[d])&&("key"in b&&"value"in b);++d)c.set(b.key,b.value);if(c.size==a.length)return c}else if(jspa.Collection.isInstance(a))return new this(a);return null}},initialize:function(a){if(this.vals=[],jspa.Map.isInstance(a)){this.superCall();for(var b=a.items();b.hasNext;){var c=b.next();this.set(c[0],c[1])}}else this.superCall(a)},get:function(a){var b=this.seq.indexOf(a);return b>-1?this.vals[b]:void 0},add:function(a){this.set(a)},set:function(a,b){var c=this.seq.indexOf(a);0>c&&(c=this.seq.length,this.seq[c]=a,this.size++),this.vals[c]=b},remove:function(a){var b=this.seq.indexOf(a);b>-1&&(this.seq.splice(b,1),this.vals.splice(b,1),this.size--)},items:function(){var a=this;return new jspa.IndexIterator(this.size,function(b){return[a.seq[b],a.vals[b]]})},keys:function(){return this.iterator()},values:function(){var a=this;return new jspa.IndexIterator(this.size,function(b){return a.seq[b]})},toString:function(){for(var a="",b=0,c=this.size;c>b;++b)""!=a&&(a+=", "),a+=this.seq[b],a+=": ",a+=this.vals[b];return"["+a+"]"},toJSON:function(){for(var a=[],b=0,c=this.size;c>b;++b)a.push({key:this.seq[b],value:this.vals[b]});return a}}),jspa.Promise=Object.inherit(Bind,{extend:{when:function(a){var b=a&&void 0!==a.length?a:arguments,c=b.length,d=new jspa.Deferred,e=new Array(c);return Array.prototype.forEach.call(b,function(a,b){a.done(function(a){e[b]=arguments.length<=1?a:Array.prototype.slice.call(arguments),--c||d.resolveWith(this,e)}).fail(function(){d.rejectWith(this,arguments)})}),d.promise()}},initialize:function(a){this.deferred=a},state:{get:function(){return this.deferred._state}},promise:function(){return this},always:function(a){return this.done(a),this.fail(a),this.promise()},done:function(a){return a&&("pending"==this.state?this.deferred.doneCallbacks.push(a):"resolved"==this.state&&this.deferred.call(a)),this.promise()},fail:function(a){return a&&("pending"==this.state?this.deferred.failCallbacks.push(a):"rejected"==this.state&&this.deferred.call(a)),this.promise()},then:function(a,b){if(a||b){var c=new jspa.Deferred;return this.done(this.filter(c,a,"resolve")),this.fail(this.filter(c,b,"reject")),c.promise()}return this.promise()},filter:function(a,b,c){var d=this.promise();return function(){var e=this==d?a.promise():this;if(b){var f;try{f=b.apply(this,arguments)}catch(g){return a.rejectWith(e,[g]),void 0}if(void 0!==f)return f&&f.promise?f.promise().done(function(){return a.resolveWith(this,arguments)}).fail(function(){return a.rejectWith(this,arguments)}):a.resolveWith(e,void 0!==f.length?f:[f]),void 0}a[c+"With"](e,arguments)}}}),jspa.Deferred=jspa.Promise.inherit({_promise:null,_state:"pending",thisArg:null,args:null,initialize:function(){this.superCall(this),this.doneCallbacks=[],this.failCallbacks=[]},promise:function(){return this._promise||(this._promise=new jspa.Promise(this)),this._promise},reject:function(){this.rejectWith(void 0,Array.prototype.slice.call(arguments))},rejectWith:function(a,b){a=a||this.promise(),"pending"==this.state&&(this._state="rejected",this.thisArg=a,this.args=b,this.call(this.failCallbacks)||jspa.EntityManagerFactory.onError.apply(jspa.EntityManagerFactory,b),this.doneCallbacks=null,this.failCallbacks=null)},resolve:function(){this.resolveWith(void 0,Array.prototype.slice.call(arguments))},resolveWith:function(a,b){a=a||this.promise(),"pending"==this.state&&(this._state="resolved",this.thisArg=a,this.args=b,this.call(this.doneCallbacks),this.doneCallbacks=null,this.failCallbacks=null)},call:function(a){a=Array.isInstance(a)?a:[a];for(var b,c=0;b=a[c];++c)b.apply(this.thisArg,this.args);return c>0}}),jspa.util.QueueConnector=Object.inherit({initialize:function(a,b){this.queue=a,this.connector=b},send:function(a){return this.connector.send(this,a)},sendBlocked:function(a){return this.connector.send(this,a,!0),a},wait:function(a,b,c){return this.queue.wait(this,a).then(b,c)},yield:function(a){return this.queue.wait(this).then(a)}}),jspa.EntityManager=jspa.util.QueueConnector.inherit({isOpen:{get:function(){return this.queue.isPrevented}},initialize:function(a){this.superCall(new jspa.util.Queue,a.connector),this.entities={},this.newOidCounter=0,this.entityManagerFactory=a,this.metamodel=a.metamodel,this.transaction=new jspa.EntityTransaction(this)},getReference:function(a,b){var c,d;String.isInstance(a)?(String.isInstance(b)&&(a+="/"+b),c=a,d=this.metamodel.entity(c.substring(0,c.lastIndexOf("/")))):(d=this.metamodel.entity(a),c=d.identifier+"/"+b);var e=this.entities[c];return e||(e=d.create(),this.replaceReference(null,c,e)),e},createQuery:function(a,b){return b?new jspa.TypedQuery(this,a,b):new jspa.Query(this,a)},clear:function(a,b){return this.yield().then(function(){for(var a in this.entities)this.removeReference(this.entities[a])}).then(a,b)},close:function(a,b){var c=this.clear(a,b);return this.queue.stop(),c},contains:function(a){var b=jspa.util.State.get(a);if(!b)return!1;var c=b.type.id.getValue(a);return c&&!b.isDeleted&&this.entities[c]===a},detach:function(a,b,c){return this.yield().then(function(){return this.removeReference(a),a}).then(b,c)},find:function(a,b,c,d){return this.yield().then(function(){var c=this.getReference(a,b),d=jspa.util.State.get(c);if(d.isLoaded)return c;var e=0,f=d.type.id.getValue(c);this.transaction.isChanged(f)&&(e=this.transaction.tid);var g=this.send(new jspa.message.GetObject(d,e)).then(function(){return d.isDeleted&&(this.removeReference(c),c=null),c});return this.wait(g)}).then(c,d)},findBlocked:function(a,b){var c,d;if(jspa.util.State.isInstance(a))c=a,d=c.type;else{var e=this.getReference(a,b);d=this.metamodel.entity(e.constructor),c=jspa.util.State.get(e)}if(!c.isLoaded){var f=0,g=d.id.getValue(c.entity);if(this.transaction.isChanged(g)&&(f=this.transaction.tid),this.sendBlocked(new jspa.message.GetObject(c,f)),c.isDeleted)throw this.removeReference(c.entity),new jspa.error.EntityNotFoundError(d.id.getValue(c.entity))}return c.entity},flush:function(a,b){var c=this.yield().then(function(){var a=[];for(var b in this.entities){var c=this.entities[b],d=jspa.util.State.get(c);if(d.isDirty){var e;if(d.isTemporary){var f=new jspa.message.PostObject(d);f.temporaryIdentifier=d.type.id.getValue(c),e=this.send(f).done(function(a){var b=a.state,c=b.type.id.getValue(b.entity);this.transaction.setChanged(c),this.replaceReference(a.temporaryIdentifier,c,b.entity)})}else e=d.isDeleted?this.send(new jspa.message.DeleteObject(d)).done(function(a){var b=a.state,c=b.type.id.getValue(b.entity);this.transaction.setChanged(c),this.transaction.isActive||this.removeReference(b.entity)}):this.send(new jspa.message.PutObject(d)).done(function(a){var b=a.state;if(a.state.isDeleted)this.removeReference(b.entity);else{var c=b.type.id.getValue(b.entity);this.transaction.setChanged(c)}});a.push(e)}}return a.length?jspa.Promise.when(a):void 0}).then(function(){if(!this.transaction.isActive){var a=[];for(var b in this.entities){var c=this.entities[b],d=jspa.util.State.get(c);if(d.isDirty){var e=this.send(new jspa.message.PutObject(d)).done(function(a){a.state.isDeleted&&this.removeReference(a.state.entity)});a.push(e)}}if(a.length)return jspa.Promise.when(a)}});return this.wait(c).then(a,b)},merge:function(a,b,c){return this.yield().then(function(){var b=this.metamodel.entity(a.constructor),c=b.id.getValue(a);if(c)return this.find(c).then(function(b){if(b&&b.constructor==a.constructor){for(var d=this.metamodel.entity(b.constructor),e=d.attributes();e.hasNext;){var f=e.next();f.setValue(b,f.getValue(a))}return b}throw new jspa.error.EntityNotFoundError(c)});throw new jspa.error.IllegalEntityError(a)}).then(b,c)},persist:function(a,b,c){return this.yield().then(function(){return this.addReference(a),a}).then(b,c)},refresh:function(a,b,c){return this.yield().then(function(){if(this.contains(a)){var b=jspa.util.State.get(a);if(b.isTemporary)throw new jspa.error.IllegalEntityError(a);var c=0,d=b.type.id.getValue(a);this.transaction.isChanged(d)&&(c=this.transaction.tid),b.isDirty=!1;var e=this.send(new jspa.message.GetObject(b,c)).then(function(){if(b.isDeleted)throw this.removeReference(a),new jspa.error.EntityNotFoundError(d)});return this.wait(e)}throw new jspa.error.IllegalEntityError(a)}).then(b,c)},remove:function(a,b,c){return this.yield().then(function(){var b=jspa.util.State.get(a);if(b)this.contains(a)&&(b.isTemporary?this.removeReference(a):b.setDeleted());else{var c=this.metamodel.entity(a.constructor);if(!c)throw new jspa.error.IllegalEntityError(a);var d=c.id.getValue(a);if(d)throw new jspa.error.EntityExistsError(d)}}).then(b,c)},addReference:function(a){var b,c=jspa.util.State.get(a);if(!this.contains(a))if(c&&c.isDeleted)c.setPersistent();else{if(b=this.metamodel.entity(a.constructor),!b)throw new jspa.error.IllegalEntityError(a);var d=b.id.getValue(a);if(d)throw new jspa.error.EntityExistsError(d);var e="/temporary/"+b.identifier.substring(4);e+="/"+ ++this.newOidCounter,c=this.replaceReference(null,e,a),c.setTemporary()}b=c.type;for(var f=b.attributes();f.hasNext;){var g=f.next();if(g.isAssociation){var h=g.getValue(a);h&&this.addReference(h)}}},replaceReference:function(a,b,c){a in this.entities&&delete this.entities[a];var d=jspa.util.State.get(c);if(!d){var e=this.metamodel.entity(c.constructor);d=new jspa.util.State(this,e,c)}return d.type.id.setValue(c,b),this.entities[b]=c,d},removeReference:function(a){var b=jspa.util.State.get(a);if(!b)throw new jspa.error.IllegalEntityError(a);b.remove(),delete this.entities[b.type.id.getValue(a)]}}),jspa.EntityManagerFactory=Object.inherit({extend:{onError:function(a){console.error(a)}},isDefining:!1,initialize:function(a,b){this.connector=jspa.connector.Connector.create(a,b),this.metamodel=new jspa.metamodel.Metamodel,this.persistenceUnitUtil=new jspa.PersistenceUnitUtil(this.metamodel),this.pendingQueues=[];var c=new jspa.message.GetAllSchemas(this.metamodel);this.connector.send(this,c).then(function(a){return this.ready(a.models)}).done(function(){for(var a,b=0;a=this.pendingQueues[b];++b)a.start();this.pendingQueues=null}).fail(function(a){jspa.EntityManagerFactory.onError(a)})},ready:function(a){if(this.newModel){var b=this.newModel.filter(function(b){return!(b["class"]in a)});if(this.newModel=null,b.length>0){var c=new jspa.message.PostAllSchemas(this.metamodel,b);return this.connector.send(this,c).then(function(a){this.ready(a.models)})}}for(var d in a){var e=a[d];this.metamodel.addType(e)}},createEntityManager:function(){var a=new jspa.EntityManager(this);if(this.pendingQueues){var b=a.queue;b.wait(),this.pendingQueues.push(b)}return a},define:function(a){this.newModel=a}}),jspa.EntityTransaction=jspa.util.QueueConnector.inherit({isActive:{get:function(){return Boolean(this.tid)}},initialize:function(a){this.superCall(a.queue,a.connector),this.entityManager=a,this.tid=null,this.rollbackOnly=!1,this.readSet=null,this.changeSet=null},begin:function(a,b){return this.yield().then(function(){var a=this.send(new jspa.message.PostTransaction).done(function(a){this.tid=a.tid,this.rollbackOnly=!1,this.readSet={},this.changeSet={}});return this.wait(a)}).then(a,b)},commit:function(a,b){return this.yield().then(function(){return this.getRollbackOnly()?this.rollback().then(function(){throw new jspa.error.RollbackError}):this.wait(this.entityManager.flush()).then(function(){var a=[];for(var b in this.readSet)a.push({oid:b,version:this.readSet[b]});var c=this.send(new jspa.message.PutTransactionCommitted(this.tid,a));return this.wait(c).then(function(a){this.tid=null,this.readSet=null,this.changeSet=null;var b=a.oids;for(var c in b){var d=b[c],e=this.entityManager.entities[c];if(e){var f=jspa.util.State.get(e);"DELETED"==d||f.isDeleted?this.entityManager.removeReference(e):f.setDatabaseValue(f.type.version,d)}}})})}).then(a,b)},getRollbackOnly:function(){return this.rollbackOnly},rollback:function(a,b){return this.yield().then(function(){var a=this.send(new jspa.message.PutTransactionAborted(this.tid));this.wait(a).then(function(){return this.tid=null,this.readSet=null,this.changeSet=null,this.entityManager.clear()},function(){return this.entityManager.clear()})}).then(a,b)},setRollbackOnly:function(){return this.yield().done(function(){this.rollbackOnly=!0})},isRead:function(a){return this.isActive&&a in this.readSet},setRead:function(a,b){this.isActive&&!this.isChanged(a)&&(this.readSet[a]=b)},isChanged:function(a){return this.isActive&&a in this.changeSet},setChanged:function(a){this.isActive&&(delete this.readSet[a],this.changeSet[a]=!0)}}),jspa.PersistenceUnitUtil=Object.inherit({initialize:function(a){this.metamodel=a},getIdentifier:function(a){var b=this.metamodel.entity(classOf(a)),c=b.id.getValue(a);return c&&0!=c.indexOf("/temporary/")?c.substring(c.lastIndexOf("/")+1):null},isLoaded:function(a,b){var c=jspa.util.State.get(a);if(c){if(c.isLoaded){if(b){var d=c.type.getAttribute(b);if(d.isAssociation){var e=d.getValue(a);return!e||this.isLoaded(e)}return!0}return!0}return!1}return!0}}),jspa.Query=jspa.util.QueueConnector.inherit({firstResult:0,maxResults:Number.MAX_VALUE,initialize:function(a,b){this.superCall(a.queue,a.connector),this.entityManager=a,this.qlString=b},getResultList:function(a,b){return this.yield().then(function(){var a,b=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(this.qlString){if(!b)throw new PositionError("Only typed queries can be executed.");var c=this.qlString;String.isInstance(c)||(c=JSON.stringify(c)),a=new jspa.message.GetBucketQuery(b,c,this.firstResult,this.maxResults)}else a=new jspa.message.GetAllOids(b,this.firstResult,this.maxResults);return this.wait(this.send(a)).then(function(){return this.createResultList(a.oids)})}).then(a,b)},getSingleResult:function(a,b){return this.yield().then(function(){var a=this.resultClass?this.entityManager.metamodel.entity(this.resultClass):null;if(!this.qlString){var b=new jspa.message.GetAllOids(a,this.firstResult,1);return this.wait(this.send(b)).then(function(a){return this.createResultList(a.oids)}).then(function(a){return a.length?a[0]:null})}}).then(a,b)},createResultList:function(a){var b=new Array(a.length);if(a.length){var c=[];return a.forEach(function(a,d){var e=this.entityManager.find(a.oid||a).done(function(a){b[d]=a});c.push(e)},this),jspa.Promise.when(c).then(function(){return[b]})}return[b]}}),jspa.TypedQuery=jspa.Query.inherit({initialize:function(a,b,c){this.superCall(a,b),this.resultClass=c}}),jspa.binding.Accessor=Object.inherit({getValue:function(a,b){return a[b.name]},setValue:function(a,b,c){a[b.name]=c}}),jspa.binding.ClassUtil=Object.inherit({extend:{classLoaders:[],initialize:function(){this.addClassLoader(this.proxyLoader),this.addClassLoader(this.globalLoader),this.addClassLoader(this.moduleLoader)},loadClass:function(a){for(var b,c=/\/db\/(([\w\.]*)\.)?(\w*)/.exec(a.identifier),d=c[1],e=c[3],f=this.classLoaders.length-1;b=this.classLoaders[f];--f)try{return b(a,d,e)}catch(g){}throw new TypeError("The class for "+a.identifier+" was not found!")},addClassLoader:function(a){this.classLoaders.push(a)},removeClassLoader:function(a){var b=this.classLoaders.indexOf(a);-1!=b&&this.classLoaders.splice(b,1)},globalLoader:function(a,b,c){var d="undefined"!=typeof window?window:global,e=d;if(b)for(var f,g=b.split("."),h=0;e&&(f=g[h]);++h)e=e[f];var i=e&&e[c];if(i)return i;throw new TypeError("The class was not found in the global context.")},moduleLoader:function(a,b,c){for(var d=module;d=d.parent;)if(c in d)return c[d];throw new TypeError("The class was not found in the parent modules.")},proxyLoader:function(a){if(a.isEntity)return console.log("Initialize proxy class for entity "+a.identifier+"."),a.supertype.typeConstructor.inherit({});if(a.isEmbeddable)return console.log("Initialize proxy class for embeddable "+a.identifier+"."),Object.inherit({});throw new TypeError("No proxy class can be initialized.")}},getIdentifier:function(a){return a.__jspaId__},setIdentifier:function(a,b){a.__jspaId__=b},create:function(a){return Object.create(a.typeConstructor.prototype)},loadClass:function(a){return jspa.binding.ClassUtil.loadClass(a)},enhance:function(a,b){Object.defineProperty(b.prototype,"_objectInfo",{value:{"class":a.identifier},writable:!0,enumerable:!1});for(var c,d=0;c=a.declaredAttributes[d];++d)this.enhanceProperty(a,c,b)},enhanceProperty:function(a,b,c){var d="_"+b.name;Object.defineProperty(c.prototype,b.name,{get:function(){return jspa.util.State.readAccess(this),this[d]},set:function(a){jspa.util.State.writeAccess(this),this[d]=a},configurable:!0,enumerable:!0})}}),jspa.collection.Collection=Trait.inherit({size:{get:function(){return jspa.util.State.readAccess(this),this._size},set:function(a){this._size=a}},has:function(a){return jspa.util.State.readAccess(this),this.superCall(a)},add:function(a){jspa.util.State.writeAccess(this),this.superCall(a)},remove:function(a){jspa.util.State.writeAccess(this),this.superCall(a)},items:function(){return jspa.util.State.readAccess(this),this.superCall()},iterator:function(){return jspa.util.State.readAccess(this),this.superCall()},toString:function(){return jspa.util.State.readAccess(this),this.superCall()},toJSON:function(){return jspa.util.State.readAccess(this),this.superCall()}}),jspa.collection.List=jspa.collection.Collection.inherit({get:function(a){return jspa.util.State.readAccess(this),this.superCall(a)},set:function(a,b){jspa.util.State.writeAccess(this),this.superCall(a,b)},indexOf:function(a){return jspa.util.State.readAccess(this),this.superCall(a)},lastIndexOf:function(a){return jspa.util.State.readAccess(this),this.superCall(a)}}),jspa.collection.Map=jspa.collection.Collection.inherit({hasKey:function(a){return jspa.util.State.readAccess(this),this.superCall(a)},hasValue:function(a){return jspa.util.State.readAccess(this),this.superCall(a)},get:function(a){return jspa.util.State.readAccess(this),this.superCall(a)},set:function(a,b){jspa.util.State.writeAccess(this),this.superCall(a,b)},removeKey:function(a){jspa.util.State.writeAccess(this),this.superCall(a)},removeValue:function(a){jspa.util.State.writeAccess(this),this.superCall(a)},keys:function(){return jspa.util.State.readAccess(this),this.superCall()}}),jspa.collection.Set=jspa.collection.Collection.inherit({}),jspa.connector.Connector=Object.inherit({extend:{create:function(a,b){if(a||"undefined"==typeof window||(a=window.location.hostname,b=window.location.port),-1!=a.indexOf("/")){var c=/^http:\/\/([^\/:]*)(:(\d*))?\/?$/.exec(a);if(!c)throw new Error("The connection uri host "+a+" seems not to be valid");a=c[1],b=c[3]}b||(b=80);for(var d in jspa.connector){var e=jspa.connector[d];if(e.isUsable&&e.isUsable(a,b))return new e(a,b)}throw new Error("No connector is usable for the requested connection")}},initialize:function(a,b){this.host=a,this.port=b},send:function(a,b,c){c||(b.deferred=new jspa.Deferred,b.context=a);try{b.doSend(),this.doSend(b)}catch(d){if(d=jspa.error.PersistentError(d),!b.deferred)throw d;b.deferred.rejectWith(a,[d])}return b.deferred?b.deferred.promise():void 0},receive:function(a){try{a.doReceive()}catch(b){if(b=jspa.error.PersistentError(b),!a.deferred)throw b;a.deferred.rejectWith(a.context,[b])}a.deferred&&a.deferred.resolveWith(a.context,[a])},doSend:function(){throw new Error("Connector.doSend() not implemented")},prepareRequestEntity:function(a){return a.request.entity?(a.request.headers["Content-Type"]="application/json;charset=utf-8",JSON.stringify(a.request.entity)):null},prepareResponseEntity:function(a,b){var c=null;b&&b.length>0&&(c=JSON.parse(b)),a.response.entity=c}}),jspa.connector.NodeConnector=jspa.connector.Connector.inherit({extend:{isUsable:function(){if(!this.prototype.http)try{var a=require("http");a.ClientRequest&&(this.prototype.http=a)}catch(b){}return Boolean(this.prototype.http)}},doSend:function(a){if(!a.deferred)throw new Error("Blocking IO is not supported");a.request.host=this.host,a.request.port=this.port;var b=this,c=this.prepareRequestEntity(a);c&&(a.request.headers["Transfer-Encoding"]="chunked");var d=this.http.request(a.request,function(c){var d="";c.setEncoding("utf-8"),c.on("data",function(a){d+=a}),c.on("end",function(){a.response.statusCode=c.statusCode,a.response.headers=c.headers,b.prepareResponseEntity(a,d),b.receive(a)})});d.on("error",function(){b.receive(a)}),c&&d.write(c,"utf8"),d.end()}}),jspa.connector.XMLHttpConnector=jspa.connector.Connector.inherit({extend:{isUsable:function(){return"undefined"!=typeof XMLHttpRequest}},doSend:function(a){var b=new XMLHttpRequest,c="http://"+this.host+":"+this.port+a.request.path;a.deferred&&(b.onreadystatechange=this.readyStateChange.bind(this,b,a)),b.open(a.request.method,c,!!a.deferred);var d=this.prepareRequestEntity(a),e=a.request.headers;for(var f in e)b.setRequestHeader(f,e[f]);b.send(d),a.deferred||this.doReceive(b,a)},readyStateChange:function(a,b){4==a.readyState&&this.doReceive(a,b)},doReceive:function(a,b){b.response.statusCode=a.status;var c=b.response.headers;for(var d in c)c[d]=a.getResponseHeader(d);this.prepareResponseEntity(b,a.responseText),this.receive(b)}}),jspa.error.PersistentError=Error.inherit({cause:null,extend:{conv:function(a){return Error.isInstance(a)?new this(null,a):void 0}},initialize:function(a,b){this.superCall(a?a:b.message),b&&(this.cause=b,this.stack+="Caused By: "+b.message+" "+b.stack)}}),jspa.error.CommunicationError=jspa.error.PersistentError.inherit({initialize:function(a){var b=0==a.response.statusCode?"Request":"Response";this.superCall("Communication failed by handling the "+b+" for "+a.request.method+" "+a.request.path);var c=a.response.entity;for(c&&(this.stack+=c.message||"CommunicationError");c;){this.stack+="Serverside Caused by "+c.className+" "+c.message+"\n";for(var d=c.stackTrace,e=0;e<d.length;++e){var f=d[e];this.stack+="  at "+f.className+"."+f.methodName,this.stack+=" ("+f.fileName+":"+f.lineNumber+")\n"}c=c.cause}}}),jspa.error.EntityExistsError=jspa.error.PersistentError.inherit({initialize:function(a){this.superCall("Entity "+a+" exists already"),this.identity=a}}),jspa.error.EntityNotFoundError=jspa.error.PersistentError.inherit({initialize:function(a){this.superCall("Entity "+a+" is not found"),this.identity=a}}),jspa.error.IllegalEntityError=jspa.error.PersistentError.inherit({initialize:function(a){this.superCall("Entity "+a+" is not a valid entity"),this.entity=a}}),jspa.error.RollbackError=jspa.error.PersistentError.inherit({initialize:function(a){this.superCall("The transaction has been rollbacked",a)}}),jspa.message.Message=Object.inherit({deferred:null,initialize:function(a,b,c){this.request={method:a,path:b,headers:{accept:"application/json"},entity:c?c:null},this.response={statusCode:0,headers:{},entity:null}},doSend:function(){},doReceive:function(){}}),jspa.message.DeleteObject=jspa.message.Message.inherit({initialize:function(a){this.superCall("delete",a.getIdentifier()),this.state=a},doSend:function(){this.request.entity=this.state.getDatabaseObjectInfo();var a=this.state.getVersion();a&&Object.extend(this.request.headers,{"if-match":"*"==a?a:'"'+a+'"'})},doReceive:function(){switch(this.response.statusCode){case 202:case 204:case 404:this.state.setDeleted();break;default:throw new jspa.error.CommunicationError(this)}}}),jspa.message.GetAllOids=jspa.message.Message.inherit({initialize:function(a,b,c){this.superCall("get",this.createUri(a,b,c))},createUri:function(a,b,c){var d=(a?a.identifier:"/db")+"/all_oids";return b>0&&(d+=";start="+b),c<Number.MAX_VALUE&&(d+=";count="+c),d},doReceive:function(){if(200!=this.response.statusCode)throw new jspa.error.CommunicationError(this);this.oids=this.response.entity}}),jspa.message.GetAllSchemas=jspa.message.Message.inherit({initialize:function(a){this.superCall("get","/db/all_schemas"),this.metamodel=a},doReceive:function(){if(200!=this.response.statusCode)throw new jspa.error.CommunicationError(this);var a=new jspa.metamodel.ModelBuilder(this.metamodel);this.models=a.buildModels(this.response.entity)}}),jspa.message.GetBucketQuery=jspa.message.Message.inherit({initialize:function(a,b,c,d){this.superCall("get",this.createUri(a,b,c,d))},createUri:function(a,b,c,d){var e=a.identifier;return e+="?query="+encodeURIComponent(b),c>0&&(e+="?start="+c),d<Number.MAX_VALUE&&(e+="?count="+d),e},doReceive:function(){if(200!=this.response.statusCode)throw new jspa.error.CommunicationError(this);this.oids=this.response.entity}}),jspa.message.GetObject=jspa.message.Message.inherit({initialize:function(a,b){var c=a.getIdentifier();b&&(c=c.replace("/db/","/transaction/"+b+"/dbview/")),this.superCall("get",c),this.state=a},doSend:function(){var a=this.state.getVersion();a&&(Object.extend(this.request.headers,{"cache-control":"max-age=0, no-cache",pragma:"no-cache"}),this.state.isDirty||(this.request.headers["if-none-match"]="*"==a?a:'"'+a+'"'))},doReceive:function(){switch(this.response.statusCode){case 304:break;case 200:this.state.setDatabaseObject(this.response.entity),this.state.setPersistent();break;case 404:this.state.setDeleted();break;default:throw new jspa.error.CommunicationError(this)}}}),jspa.message.PostAllSchemas=jspa.message.Message.inherit({initialize:function(a,b){this.superCall("post","/db/all_schemas"),this.metamodel=a,this.types=b},doSend:function(){this.request.entity=this.types},doReceive:function(){if(200!=this.response.statusCode)throw new jspa.error.CommunicationError(this);var a=new jspa.metamodel.ModelBuilder(this.metamodel);this.models=a.buildModels(this.response.entity)}}),jspa.message.PostObject=jspa.message.Message.inherit({initialize:function(a){this.superCall("post",a.type.identifier),this.state=a},doSend:function(){this.request.entity=this.state.getDatabaseObject()},doReceive:function(){switch(this.response.statusCode){case 201:case 202:this.state.setDatabaseObject(this.response.entity),this.state.setPersistent();break;case 404:this.state.setDeleted();break;default:throw new jspa.error.CommunicationError(this)}}}),jspa.message.PostTransaction=jspa.message.Message.inherit({initialize:function(){this.superCall("post","/transaction"),Object.extend(this.response.headers,{location:null})},doReceive:function(){if(201!=this.response.statusCode)throw new jspa.error.CommunicationError(this);this.tid=this.response.headers.location.split("/transaction/").pop()}}),jspa.message.PutObject=jspa.message.Message.inherit({initialize:function(a){this.superCall("put",a.getIdentifier()),this.state=a},doSend:function(){var a=this.state.getVersion();Object.extend(this.request.headers,{"if-match":a&&"*"!=a?'"'+a+'"':"*"}),this.request.entity=this.state.getDatabaseObject()},doReceive:function(){switch(this.response.statusCode){case 200:this.state.setDatabaseObject(this.response.entity);case 202:this.state.setPersistent();break;case 404:this.state.setDeleted();break;default:throw new jspa.error.CommunicationError(this)}}}),jspa.message.PutTransactionAborted=jspa.message.Message.inherit({initialize:function(a){this.superCall("put","/transaction/"+a+"/aborted")},doReceive:function(){if(202!=this.response.statusCode)throw new jspa.error.CommunicationError(this)}}),jspa.message.PutTransactionCommitted=jspa.message.Message.inherit({initialize:function(a,b){this.superCall("put","/transaction/"+a+"/committed",b)},doReceive:function(){switch(this.response.statusCode){case 200:this.oids=this.response.entity;break;case 412:throw new jspa.error.RollbackError;default:throw new jspa.error.CommunicationError(this)}}}),jspa.metamodel.Attribute=Object.inherit({extend:{PersistentAttributeType:{BASIC:0,ELEMENT_COLLECTION:1,EMBEDDED:2,MANY_TO_MANY:3,MANY_TO_ONE:4,ONE_TO_MANY:5,ONE_TO_ONE:6}},isAssociation:{get:function(){return this.persistentAttributeType>jspa.metamodel.Attribute.PersistentAttributeType.EMBEDDED}},isCollection:{get:function(){return this.persistentAttributeType==jspa.metamodel.Attribute.PersistentAttributeType.ELEMENT_COLLECTION}},isId:!1,isVersion:!1,initialize:function(a,b){this.accessor=new jspa.binding.Accessor,this.declaringType=a,this.name=b},getValue:function(a){return this.isId||this.isVersion?a._objectInfo[this.name]:this.accessor.getValue(a,this)
},setValue:function(a,b){this.isId||this.isVersion?a._objectInfo[this.name]=b:this.accessor.setValue(a,this,b)}}),jspa.metamodel.Type=Object.inherit({extend:{PersistenceType:{BASIC:0,EMBEDDABLE:1,ENTITY:2,MAPPED_SUPERCLASS:3}},isBasic:{get:function(){return this.persistenceType==jspa.metamodel.Type.PersistenceType.BASIC}},isEmbeddable:{get:function(){return this.persistenceType==jspa.metamodel.Type.PersistenceType.EMBEDDABLE}},isEntity:{get:function(){return this.persistenceType==jspa.metamodel.Type.PersistenceType.ENTITY}},isMappedSuperclass:{get:function(){return this.persistenceType==jspa.metamodel.Type.PersistenceType.MAPPED_SUPERCLASS}},persistenceType:-1,initialize:function(a,b){this.identifier=a,this.typeConstructor=b},init:function(a){this.classUtil=a,this.classUtil.getIdentifier(this.typeConstructor)||this.classUtil.setIdentifier(this.typeConstructor,this.identifier)},create:function(){return this.classUtil.create(this)},toDatabaseValue:function(){},fromDatabaseValue:function(){}}),jspa.metamodel.BasicType=jspa.metamodel.Type.inherit({persistenceType:jspa.metamodel.Type.PersistenceType.BASIC,isCollection:!1,initialize:function(a,b){-1==a.indexOf("/")&&(a="/db/_native."+a),this.superCall(a,b)},toDatabaseValue:function(a,b){return null===b||void 0===b?null:this.typeConstructor.asInstance(b)},fromDatabaseValue:function(a,b,c){return null===c||void 0===c?null:this.typeConstructor.asInstance(c)}}),jspa.metamodel.PluralAttribute=jspa.metamodel.Attribute.inherit({extend:{CollectionType:{COLLECTION:0,LIST:1,MAP:2,SET:3}},persistentAttributeType:jspa.metamodel.Attribute.PersistentAttributeType.ELEMENT_COLLECTION,initialize:function(a,b,c){this.superCall(a,b),this.elementType=c},getDatabaseValue:function(a,b){var c=this.getValue(b);if(c){this.trackedConstructor.isInstance(c)||(c=new this.trackedConstructor(c),Object.defineProperty(c,"__jspaEntity__",{value:a.entity}),this.setValue(b,c));for(var d=[],e=c.iterator();e.hasNext;){var f=e.next();null===f?d.push(f):(f=this.elementType.toDatabaseValue(a,f),null!==f&&d.push(f))}return d}return null},setDatabaseValue:function(a,b,c){var d=null;if(c){d=this.getValue(b),this.trackedConstructor.isInstance(d)||(d=new this.trackedConstructor,Object.defineProperty(d,"__jspaEntity__",{value:a.entity}));var e=d.seq;e.length>c.length&&e.splice(c.length,e.length-c.length);for(var f=0,g=c.length;g>f;++f)e[f]=this.elementType.fromDatabaseValue(a,e[f],c[f]);d.size=c.length}this.setValue(b,d)}}),jspa.metamodel.CollectionAttribute=jspa.metamodel.PluralAttribute.inherit({collectionType:jspa.metamodel.PluralAttribute.CollectionType.COLLECTION,initialize:function(a,b,c){this.superCall(a,b,c),this.trackedConstructor=jspa.Collection.inherit(jspa.collection.Collection,{})}}),jspa.metamodel.ManagedType=jspa.metamodel.Type.inherit({AttributeIterator:Object.inherit(jspa.Iterator,{nextAttr:null,index:0,initialize:function(a){this.type=a,this.next()},next:function(){for(var a=this.nextAttr;this.type.declaredAttributes.length==this.index&&(this.type=this.type.supertype);)this.index=0;return this.hasNext=null!=this.type,this.hasNext&&(this.nextAttr=this.type.declaredAttributes[this.index++]),a}}),declaredAttributes:null,initialize:function(a,b){this.superCall(a,b),this.declaredAttributes=[]},init:function(a){this.typeConstructor?this.superCall(a):(this.typeConstructor=a.loadClass(this),this.superCall(a),this.classUtil.enhance(this,this.typeConstructor))},attributes:function(){return new this.AttributeIterator(this)},getAttribute:function(a){var b=this.getDeclaredAttribute(a);return!b&&this.supertype&&(b=this.supertype.getAttribute(a)),b},getDeclaredAttribute:function(a){for(var b,c=0;b=this.declaredAttributes[c];++c)if(b.name==a)return b;return null},fromDatabaseValue:function(a,b,c){if(c&&c._objectInfo["class"]==this.identifier)for(var d=this.attributes();d.hasNext;){var e=d.next();e.setDatabaseValue(a,b,c[e.name])}else b=null;return b},toDatabaseValue:function(a,b){var c=null;if(this.typeConstructor.isInstance(b)){c={_objectInfo:{"class":this.identifier}};for(var d=this.attributes();d.hasNext;){var e=d.next();c[e.name]=e.getDatabaseValue(a,b)}}return c}}),jspa.metamodel.EmbeddableType=jspa.metamodel.ManagedType.inherit({persistenceType:jspa.metamodel.Type.PersistenceType.EMBEDDABLE,fromDatabaseValue:function(a,b,c){return!b&&c&&(b=this.create(),Object.defineProperty(b,"__jspaEntity__",{value:a.entity})),this.superCall(a,b,c)}}),jspa.metamodel.EntityType=jspa.metamodel.ManagedType.inherit({persistenceType:jspa.metamodel.Type.PersistenceType.ENTITY,declaredId:null,declaredVersion:null,id:{get:function(){return this.declaredId||this.supertype.id}},version:{get:function(){return this.declaredVersion||this.supertype.version}},initialize:function(a,b,c){this.superCall(a,c),this.supertype=b},fromDatabaseValue:function(a,b,c){return a.entity==b?(this.superCall(a,b,c),b):c?a.entityManager.getReference(c):null},toDatabaseValue:function(a,b){if(a.entity==b){var c=this.superCall(a,b),d=c._objectInfo,e=a.getReference();e&&(d.oid=e);var f=a.getVersion();f&&(d.version=f);var g=a.getTransactionIdentifier();return g&&(d.transaction=g),c}if(this.typeConstructor.isInstance(b)){var h=jspa.util.State.get(b);if(h&&!h.isDeleted){var i=h.getReference();if(i)return i;a.isDirty=!0}}return null}}),jspa.metamodel.ListAttribute=jspa.metamodel.PluralAttribute.inherit({collectionType:jspa.metamodel.PluralAttribute.CollectionType.LIST,initialize:function(a,b,c){this.superCall(a,b,c),this.trackedConstructor=jspa.List.inherit(jspa.collection.List,{})}}),jspa.metamodel.MapAttribute=jspa.metamodel.PluralAttribute.inherit({collectionType:jspa.metamodel.PluralAttribute.CollectionType.MAP,initialize:function(a,b,c,d){this.superCall(a,b,d),this.keyType=c,this.trackedConstructor=jspa.Map.inherit(jspa.collection.Map,{})},getDatabaseValue:function(a,b){var c=this.getValue(b);if(c){this.trackedConstructor.isInstance(c)||(c=new this.trackedConstructor(c),Object.defineProperty(c,"__jspaEntity__",{value:a.entity}),this.setValue(b,c));for(var d=[],e=c.items();e.hasNext;){var f=e.next(),g=this.keyType.toDatabaseValue(a,f[0]);(null===f[0]||null!==g)&&d.push({key:g,value:this.elementType.toDatabaseValue(a,f[1])})}return d}return null},setDatabaseValue:function(a,b,c){var d=null;if(c){d=this.getValue(b),this.trackedConstructor.isInstance(d)||(d=new this.trackedConstructor,Object.defineProperty(d,"__jspaEntity__",{value:a.entity}));var e=d.seq,f=d.vals;e.length>c.length&&(e.splice(c.length,e.length-c.length),f.splice(c.length,f.length-c.length));for(var g=0,h=c.length;h>g;++g){var i=c[g];e[g]=this.keyType.fromDatabaseValue(a,e[g],i.key),f[g]=this.elementType.fromDatabaseValue(a,f[g],i.value)}d.size=c.length}this.setValue(b,d)}}),jspa.metamodel.Metamodel=Object.inherit({initialize:function(){this.baseTypes={},this.entities={},this.embeddables={},this.classUtil=new jspa.binding.ClassUtil,this.addType(new jspa.metamodel.BasicType("Boolean",Boolean)),this.addType(new jspa.metamodel.BasicType("Float",Number)),this.addType(new jspa.metamodel.BasicType("Integer",Number)),this.addType(new jspa.metamodel.BasicType("String",String)),this.addType(new(jspa.metamodel.BasicType.inherit({toDatabaseValue:function(a,b){var c=this.superCall(a,b);return c&&(c=c.toISOString(),c=c.substring(0,c.indexOf("T"))),c}}))("Date",Date)),this.addType(new(jspa.metamodel.BasicType.inherit({toDatabaseValue:function(a,b){var c=this.superCall(a,b);return c&&(c=c.toISOString(),c=c.substring(c.indexOf("T")+1)),c},fromDatabaseValue:function(a,b,c){return this.superCall(a,b,c?"1970-01-01T"+c:c)}}))("Time",Date)),this.addType(new jspa.metamodel.BasicType("DateTime",Date));var a=new jspa.metamodel.EntityType("/db/_native.Object",null,Object);a.declaredAttributes=[],a.declaredId=new jspa.metamodel.SingularAttribute(a,"oid",this.baseType(String)),a.declaredId.isId=!0,a.declaredVersion=new jspa.metamodel.SingularAttribute(a,"version",this.baseType(String)),a.declaredVersion.isVersion=!0,this.addType(a)},identifierArg:function(a){var b;return String.isInstance(a)?(b=a,0!=b.indexOf("/db/")&&(b="/db/"+a)):b=this.classUtil.getIdentifier(a),b},entity:function(a){var b=this.identifierArg(a);return b?this.entities[b]:null},baseType:function(a){String.isInstance(a)&&-1==a.indexOf("_native.")&&(a="/db/_native."+a);var b=this.identifierArg(a);return b?this.baseTypes[b]:null},embeddable:function(a){var b=this.identifierArg(a);return b?this.embeddables[b]:null},managedType:function(a){return this.baseType(a)||this.entity(a)||this.embeddable(a)},addType:function(a){var b;a.isBasic?b=this.baseTypes:a.isEmbeddable?b=this.embeddables:a.isEntity&&(b=this.entities),a.identifier in b||(a.init(this.classUtil),b[a.identifier]=a)}}),jspa.metamodel.ModelBuilder=Object.inherit({initialize:function(a){this.metamodel=a,this.objectType=a.entity(Object)},getModel:function(a){var b=null;if(0==a.indexOf("/db/_native")?b=this.metamodel.baseType(a):(b=this.metamodel.entity(a),b||(b=this.metamodel.embeddable(a)),!b&&a in this.models&&(b=this.models[a]),b||(b=this.buildModel(a))),b)return b;throw new TypeError("no model available for "+a)},buildModels:function(a){this.modelDescriptors={};for(var b,c=0;b=a[c];++c)this.modelDescriptors[b["class"]]=b;this.models={};for(var d in this.modelDescriptors)try{var e=this.getModel(d);this.buildAttributes(e)}catch(f){throw new jspa.error.PersistentError("Can't create model for entity class "+d,f)}return this.models},buildModel:function(a){var b=this.modelDescriptors[a];if(b){var c,d=b.superClass,e=d?this.getModel(d):this.objectType;return c=b.embedded?new jspa.metamodel.EmbeddableType(a):new jspa.metamodel.EntityType(a,e),this.models[a]=c,c}return null},buildAttributes:function(a){if(a.identifier in this.models){for(var b,c=this.modelDescriptors[a.identifier].fields,d=a.declaredAttributes,e=0;b=c[e];++e)d.push(this.buildAttribute(a,b.name,b.type));return d}return null},buildAttribute:function(a,b,c){if(0!=c.indexOf("/db/_native.collection"))return new jspa.metamodel.SingularAttribute(a,b,this.getModel(c));var d=c.substring(0,c.indexOf("[")),e=c.substring(c.indexOf("[")+1,c.indexOf("]")).trim();switch(d){case"/db/_native.collection.List":return new jspa.metamodel.ListAttribute(a,b,this.getModel(e));case"/db/_native.collection.Set":return new jspa.metamodel.SetAttribute(a,b,this.getModel(e));case"/db/_native.collection.Map":var f=e.substring(0,e.indexOf(",")).trim();return e=e.substring(e.indexOf(",")+1).trim(),new jspa.metamodel.MapAttribute(a,b,this.getModel(f),this.getModel(e));default:throw new TypeError("no collection available for "+c)}}}),jspa.metamodel.SetAttribute=jspa.metamodel.PluralAttribute.inherit({collectionType:jspa.metamodel.PluralAttribute.CollectionType.SET,initialize:function(a,b,c){this.superCall(a,b,c),this.trackedConstructor=jspa.Set.inherit(jspa.collection.Set,{})}}),jspa.metamodel.SingularAttribute=jspa.metamodel.Attribute.inherit({typeConstructor:{get:function(){return this.type.typeConstructor}},persistentAttributeType:-1,initialize:function(a,b,c){switch(this.superCall(a,b),this.type=c,c.persistenceType){case jspa.metamodel.Type.PersistenceType.BASIC:this.persistentAttributeType=jspa.metamodel.Attribute.PersistentAttributeType.BASIC;break;case jspa.metamodel.Type.PersistenceType.EMBEDDABLE:this.persistentAttributeType=jspa.metamodel.Attribute.PersistentAttributeType.EMBEDDED;break;case jspa.metamodel.Type.PersistenceType.ENTITY:this.persistentAttributeType=jspa.metamodel.Attribute.PersistentAttributeType.ONE_TO_MANY}},getDatabaseValue:function(a,b){return this.type.toDatabaseValue(a,this.getValue(b))},setDatabaseValue:function(a,b,c){this.setValue(b,this.type.fromDatabaseValue(a,this.getValue(b),c))}}),jspa.util.Queue=Object.inherit(Bind,{extend:{State:{STOPPED:0,PAUSED:1,WAITING:2,RUNNING:3}},isStopped:{get:function(){return this.state==jspa.util.Queue.State.STOPPED}},isPaused:{get:function(){return this.state==jspa.util.Queue.State.PAUSED}},isWaiting:{get:function(){return this.state==jspa.util.Queue.State.WAITING}},isRunning:{get:function(){return this.state==jspa.util.Queue.State.RUNNING}},isPrevented:{get:function(){return this.prevented}},initialize:function(){this.currentQueue=[],this.queue=this.currentQueue,this.state=jspa.util.Queue.State.STOPPED,this.count=0,this.prevented=!1},wait:function(a,b){if(!this.isRunning&&this.isPrevented)throw new Error("The queue was prevented");var c=new jspa.Deferred,d=this;return this.currentQueue.push(function(){b?b.done(function(){var b=arguments;d.run(function(){c.resolveWith(a,b)})}).fail(function(){var b=arguments;d.run(function(){c.rejectWith(a,b)})}):d.run(function(){c.resolveWith(a)})}),this.next(),c.promise()},start:function(){this.isStopped&&!this.isPrevented&&(this.state=jspa.util.Queue.State.PAUSED),this.next()},run:function(a){if(!this.isWaiting)throw new Error("Illegal state "+this.state);this.state=jspa.util.Queue.State.RUNNING,this.currentQueue=[],a(),this.currentQueue.length&&Array.prototype.unshift.apply(this.queue,this.currentQueue),this.currentQueue=this.queue,this.state=jspa.util.Queue.State.PAUSED,this.next()},next:function(){this.isPaused&&this.queue.length&&(this.state=jspa.util.Queue.State.WAITING,setTimeout(this.queue.shift(),1)),this.isPrevented&&!this.queue.length&&(this.state=jspa.util.Queue.State.STOPPED)},stop:function(){this.prevented=!0}}),jspa.util.State=Object.inherit({extend:{Type:{TEMPORARY:0,PERSISTENT:1,DIRTY:2,DELETED:3},get:function(a){return a._objectInfo&&a._objectInfo.state},readAccess:function(a){a.__jspaEntity__&&(a=a.__jspaEntity__);var b=a._objectInfo;if(b&&(b.state&&b.state.makeAvailable(),b.notAvailable))throw new jspa.error.PersistentError("Object state can not be initialized.")},writeAccess:function(a){a.__jspaEntity__&&(a=a.__jspaEntity__);var b=a._objectInfo;if(b&&(b.state&&b.state.makeDirty(),b.notAvailable))throw new jspa.error.PersistentError("Object state can not be initialized.")}},isTemporary:{get:function(){return this.state==jspa.util.State.Type.TEMPORARY}},isPersistent:{get:function(){return this.state==jspa.util.State.Type.PERSISTENT}},isDeleted:{get:function(){return this.state==jspa.util.State.Type.DELETED}},initialize:function(a,b,c){this.entityManager=a,this.type=b,this.entity=c,Object.defineProperty(this.entity,"_objectInfo",{value:{"class":this.type.identifier,notAvailable:!0,state:this}}),this.isDirty=!1,this.state=jspa.util.State.Type.PERSISTENT,this.enabled=!0},setTemporary:function(){this.entity._objectInfo.notAvailable&&(this.entity._objectInfo.notAvailable=!1,this.state=jspa.util.State.Type.TEMPORARY,this.isDirty=!0)},setPersistent:function(){this.isDeleted&&(this.isDirty=!0),this.state=jspa.util.State.Type.PERSISTENT},setDeleted:function(){this.state=jspa.util.State.Type.DELETED,this.isDirty=!0},enable:function(){this.enabled=!0},disable:function(){this.enabled=!1},makeDirty:function(){this.enabled&&(this.entity._objectInfo.notAvailable&&this.makeAvailable(),this.isDeleted||(this.isDirty=!0))},makeAvailable:function(){if(this.enabled&&this.entity._objectInfo.notAvailable)try{this.entityManager.findBlocked(this)}catch(a){}},remove:function(){this.entity._objectInfo.state=null},getIdentifier:function(){return this.type.id.getDatabaseValue(this,this.entity)},getVersion:function(){return this.type.version.getDatabaseValue(this,this.entity)},getReference:function(){var a=this.getIdentifier();if(this.isTemporary){var b=this.entityManager.transaction;a=b.isActive?"/transaction/"+b.tid+a:null}return a},getTransactionIdentifier:function(){var a=this.entityManager.transaction;return a.isActive?"/transaction/"+a.tid:null},getDatabaseObjectInfo:function(){var a={"class":this.type.identifier},b=this.getReference();b&&(a.oid=b);var c=this.getVersion();c&&(a.version=c);var d=this.getTransactionIdentifier();return d&&(a.transaction=d),a},setDatabaseObjectInfo:function(a){this.isTemporary&&this.type.id.setDatabaseValue(this,this.entity,a.oid),this.type.version.setDatabaseValue(this,this.entity,a.version)},getDatabaseObject:function(){this.disable(),this.isDirty=!1;var a=this.type.toDatabaseValue(this,this.entity);return this.enable(),a},setDatabaseObject:function(a){this.setDatabaseObjectInfo(a._objectInfo),this.entity._objectInfo.notAvailable=!1,this.isDirty||(this.disable(),this.type.fromDatabaseValue(this,this.entity,a),this.enable())}});